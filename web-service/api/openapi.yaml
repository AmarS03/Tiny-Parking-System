openapi: "3.0.0"
info:
  title: "Tiny Parking System API"
  version: "1.0.0"
  description: "API for the Tiny Parking System project for the Embedded Software for the Internet of Things course - 2025/2026"
servers:
  - url: "https://tinyparkingsystem-api.vercel.app/"
paths:
  /status:
    get:
      summary: "Returns the status of the ESP microcontroller, the parking info and its sensors"
      responses:
        '200':
          description: "Current system status"
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/systemStatus'
    put:
      summary: "Updates the status of the ESP microcontroller, the parking info and its sensors"
      requestBody:
        required: true
        content:
          application/json:
            schema:
                $ref: '#/components/schemas/systemStatus'
      responses:
        '200':
          description: "System status updated successfully"
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                
  /entry:
    post:
      summary: "Records a vehicle entering the parking system and returns the entry decision"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/entryRequest'
      responses:
        '200':
          description: "Entry attempt processed successfully"
          content: 
            application/json:
              schema:
                $ref: '#/components/schemas/entryResponse'
        '400':
          description: "Invalid entry payload"
                
  /exit:
    post:
      summary: "Records a vehicle exiting the parking system"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/exitRequest'
      responses:
        '200':
          description: "Exit recorded successfully"
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
        '400':
          description: "Invalid exit payload (no license plate)"

components:
  schemas:
    systemStatus:
      type: object
      properties:
        boardStatus:
          type: array
          items:
            $ref: '#/components/schemas/moduleStatus'
        logs:
          type: array
          items:
            $ref: '#/components/schemas/logEntry'
        allowedPlates:
          type: array
          items:
            type: string
        spots:
          type: array
          items:
            $ref: '#/components/schemas/parkingSpot'
        openingTime:
          type: string
          format: time
          description: "Opening time in HH:mm format"
        closingTime:
          type: string
          format: time
          description: "Closing time in HH:mm format"

    moduleStatus:
      type: object
      properties:
        name:
          type: string
          description: "Module name"
        status:
          type: string
          enum: ["No connection", "Active", "Failed"]
          description: "Module connection status"
        espStatus:
          type: string
          description: "ESP module status message"
      required:
        - name
        - status
        - espStatus

    logEntry:
      type: object
      properties:
        type:
          type: string
          enum: ["info", "success", "warning", "error"]
          description: "Log entry type"
        message:
          type: string
          description: "Log message"
        imageUrl:
          type: string
          format: uri
          description: "Optional image URL associated with the log entry"
        timestamp:
          type: string
          format: date-time
          description: "ISO 8601 timestamp of the log entry"
      required:
        - type
        - message
        - timestamp

    parkingSpot:
      type: object
      properties:
        id:
          type: integer
          description: "Parking spot ID (1-based index)"
        isOccupied:
          type: boolean
          description: "Whether the spot is occupied"
        occupiedBy:
          type: string
          description: "License plate of the vehicle occupying the spot (empty if not occupied)"
        occupiedAt:
          type: string
          format: date-time
          nullable: true
          description: "Timestamp when the spot was occupied"
      required:
        - id
        - isOccupied
        - occupiedBy
        - occupiedAt

    entryRequest:
      type: object
      properties:
        licensePlate:
          type: string
          description: "Vehicle license plate (alphanumeric, max 7 characters)"
          pattern: '^[A-Z0-9]{1,7}$'
        imageUrl:
          type: string
          format: uri
          description: "Optional image URL of the vehicle"
        recordedWeight:
          type: number
          description: "Weight of the vehicle in kilograms"
      required:
        - licensePlate
        - recordedWeight

    entryResponse:
      type: object
      properties:
        allowed:
          type: boolean
          description: "Whether the vehicle entry is allowed"
        message:
          type: string
          description: "Decision message (e.g., 'License plate allowed', 'Invalid license plate', 'No parking spots available')"
      required:
        - allowed
        - message

    exitRequest:
      type: object
      properties:
        licensePlate:
          type: string
          description: "Vehicle license plate"
      required:
        - licensePlate
